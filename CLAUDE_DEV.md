# POE Macro v3.0 開発ガイドライン

## 関連ドキュメント

開発を進める際は、以下のドキュメントも参照してください：

- **[要件定義書](docs/POE_Macro_v3_要件定義書.md)**: プロジェクトの詳細な要件と仕様
- **[開発計画書](docs/POE_Macro_v3_開発計画書.md)**: 開発フェーズとタスクの詳細
- **[開発記録](CLAUDE.md)**: 日々の開発進捗と技術的決定事項

特に要件定義書は、各モジュールの具体的な動作仕様（タイミング、キー割り当て、画像認識の詳細など）が記載されているため、実装時に必ず参照してください。

## アーキテクチャ概要

### ディレクトリ構造
```
POE_Macro_v3/
├── src/                    # ソースコード
│   ├── core/              # コア機能（マクロ制御、設定管理）
│   ├── modules/           # 各種モジュール（フラスコ、スキル、Tincture）
│   ├── gui/               # GUI関連
│   └── utils/             # ユーティリティ（画面キャプチャ、キーボード入力）
├── assets/                 # 画像アセット
│   └── images/
│       ├── divination_card_buff/  # Divination Cardバフアイコン
│       ├── tincture/             # Tincture状態画像
│       ├── utility/              # ユーティリティフラスコ画像
│       ├── unique/               # ユニークフラスコ画像
│       └── mana/                 # マナフラスコ画像
├── config/                 # 設定ファイル
├── tests/                  # テストコード
└── docs/                   # ドキュメント
```

### モジュール設計

#### 1. Core（コア機能）
- **macro_controller.py**: マクロ全体の制御（開始/停止、モジュール管理）
- **config_manager.py**: 設定ファイルの読み込み/保存

#### 2. Utils（ユーティリティ）
- **keyboard_input.py**: キーボード入力制御（アンチチート対策込み）
- **screen_capture.py**: 画面キャプチャ（マルチモニター対応）
- **image_recognition.py**: 画像認識（OpenCVテンプレートマッチング）

#### 3. Modules（機能モジュール）
- **flask_module.py**: フラスコ自動使用
- **skill_module.py**: スキル自動使用
- **tincture_module.py**: Tincture自動使用
- **log_monitor.py**: ログファイル監視

#### 4. GUI
- **main_window.py**: メインウィンドウ（タブ式設定画面）

## コーディング規約

### Python スタイル
- PEP 8準拠
- 型ヒントを積極的に使用
- docstringは必須（Google style）
- Black でフォーマット

### エラーハンドリング
```python
try:
    # 処理
except SpecificException as e:
    logger.error(f"具体的なエラーメッセージ: {e}")
    # 必要に応じて再raise
```

### ログ出力
```python
logger.debug()  # デバッグ情報
logger.info()   # 通常の情報
logger.warning() # 警告
logger.error()  # エラー
```

## 重要な実装ポイント

### 1. アンチチート対策
- 全てのキー入力にランダム遅延（0-50ms）
- キー押下時間もランダム化（50-100ms）
- ループ間隔にも揺らぎを導入

### 2. マルチスレッド設計
- 各モジュールは独立したスレッドで動作
- 適切な停止処理（graceful shutdown）
- スレッドセーフな実装

### 3. 画像認識の最適化
- テンプレート画像の事前読み込み
- 認識領域の限定（全画面ではなく必要な部分のみ）
- 閾値の調整可能化

### 4. 設定管理
- デフォルト設定とユーザー設定の分離
- 設定変更の即時反映（再起動不要）
- 設定のバリデーション

## テスト方針

### ユニットテスト
- 各モジュールの個別テスト
- モック使用（画面キャプチャ、キーボード入力）

### 統合テスト
- モジュール間の連携テスト
- 実際のゲーム環境でのテスト

## デバッグ機能

### デバッグモード
- 画像認識結果の可視化
- キー入力のログ出力
- タイミング情報の詳細表示

## パフォーマンス目標
- CPU使用率: 5%以下
- メモリ使用量: 200MB以下
- 画像認識処理: 100ms以内

## セキュリティ考慮事項
- 設定ファイルのパス情報は相対パス使用
- ログに個人情報を含めない
- 例外メッセージの適切な処理