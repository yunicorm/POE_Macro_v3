# Path of Exile Automation Macro v3.0 要件定義書（更新版）

## 改訂履歴
- 2025-01-15: 初版作成
- 2025-07-05: Grace Period機能追加、全機能実装完了に合わせた仕様更新

## 1. 機能要件

### 1.1. フラスコ自動使用機能
各フラスコは、マクロ起動と同時に指定されたループ処理を開始する。独立スレッドで動作し、設定可能な間隔でのランダム遅延によりアンチチート対策を実装している。

| 対象 | スロット | 割当キー | 持続時間 | ループタイミング | 備考 |
|------|----------|----------|----------|------------------|------|
| Granite Flask | slot_1 | 1 | 7.2 秒 | 7.21秒 ～ 7.30秒 | 物理ダメージ軽減 |
| Cinderswallow Urn | slot_2 | 2 | 7.2 秒 | 7.21秒 ～ 7.30秒 | 生命力・マナ回復 |
| Wine of the Prophet | slot_4 | 4 | 20.0 秒 | 20.0秒 ～ 21.0秒 | Divination Cardバフ付与 |
| Divine Mana Flask | slot_5 | 5 | 5.0 秒 | 4.5秒 ～ 4.8秒 | マナ回復 |

**技術仕様**:
- 独立スレッド処理による非同期実行
- 設定ファイル（YAML）による動的設定変更
- 手動使用機能（GUI経由）
- 統計情報管理（使用回数追跡）

### 1.2. スキル自動使用機能
各スキルは、マクロ起動と同時に指定された間隔でのキー入力を開始する。

| 対象 | 割当キー | キー入力間隔 | 備考 |
|------|----------|-------------|------|
| Berserk | E | 0.3秒 ～ 1.0秒 のランダムな間隔 | クールダウン回復速度低下MODに対応するため、高頻度で実行。 |
| Molten Shell | R | 0.3秒 ～ 1.0秒 のランダムな間隔 | 同上。 |
| Order! To Me! | T | 3.5秒 ～ 4.0秒 のランダムな間隔 | 他のスキルより優先度を下げ、長めの間隔で実行。 |

### 1.3. Tincture (Sap of the Seasons) 自動使用機能
Tinctureは、ゲーム画面の画像認識によって状態を判別し、効率的な自動使用を実行する。Active状態検出機能により、無駄な再使用を防ぎ効果を最大化する。

- **検出対象**: オーバーレイで設定されたフラスコエリア内のTincture（3番スロット）
- **割当キー**: 3
- **検出モード**:
  - `full_flask_area`: フラスコエリア全体での検出（推奨）
  - `auto_slot3`: 3番スロット自動計算
  - `manual`: 手動指定エリア

#### 状態検出と自動使用ロジック
1. **Idle状態検出**: `sap_of_the_seasons_idle.png`とのマッチング
2. **Active状態検出**: `sap_of_the_seasons_active.png`とのマッチング
3. **スマート使用制御**:
   - Active状態: 使用せず効果維持
   - Idle状態: 即座に使用（3キー入力）
   - Unknown状態: 従来ロジックでフォールバック

#### 技術仕様
- **画像認識**: OpenCVテンプレートマッチング
- **感度調整**: 0.0-1.0（デフォルト0.7）
- **チェック間隔**: 0.1秒（設定可能）
- **最小使用間隔**: 0.5秒（設定可能）
- **統計管理**: Active/Idle/Unknown検出回数、使用回数

#### 使用する画像アセット
- **Tincture状態画像**:
  - `assets/images/tincture/sap_of_the_seasons/idle/sap_of_the_seasons_idle.png`
  - `assets/images/tincture/sap_of_the_seasons/active/sap_of_the_seasons_active.png`

#### 1.3.1 検出エリア設定機能（実装済み）
**概要**：
オーバーレイウィンドウを使用してフラスコエリアを視覚的に設定し、その領域内でTincture検出を行う機能。

**実装済み機能**：
- **オーバーレイウィンドウ（PyQt5実装）**
  - 半透明緑色矩形（Always on Top）
  - グローバルホットキー対応（pynput使用）
  - 座標・サイズのリアルタイム表示

- **エリア調整機能**
  - マウスドラッグ: 位置移動
  - Shift+ドラッグ: サイズ変更
  - マウスホイール: スケール調整（5%刻み、0.5x～2.0x）
  - 矢印キー: 1px精密位置調整
  - Shift+矢印: 1px精密サイズ調整

- **設定管理**
  - detection_areas.yaml自動保存
  - 解像度別プリセット（1920x1080, 2560x1440, 3840x2160）
  - GUI統合（キャリブレーションタブ）
  - 設定変更の即時反映

**操作仕様**：

| 操作 | 機能 |
|------|------|
| マウスドラッグ | 矩形の移動 |
| Shift+ドラッグ | サイズ変更 |
| マウスホイール | スケール調整（5%刻み） |
| 矢印キー | 1px単位の位置調整 |
| Shift+矢印 | 1px単位のサイズ調整 |
| Ctrl+S | 設定を保存 |
| F9 | オーバーレイ表示切替 |
| F10 | 設定モード終了 |

**技術仕様**：
- PyQt5による実装
- 透明度50%の緑色矩形
- pynputグローバルホットキー
- AreaSelectorクラスによる座標管理
- TinctureDetectorとの完全統合

### 1.4. Grace Period（無敵時間）機能 【実装済み】
Path of Exileでは戦闘エリアに入場すると60秒間の無敵時間（Grace Period）が適用され、プレイヤーが何らかの行動を取るまでモンスターから攻撃されない。この時間を有効活用するため、エリア入場時の自動マクロ開始を遅延させる機能。

#### 1.4.1 基本仕様
- **目的**: エリア再入場時のリスポーンキルを防ぎ、プレイヤーが安全に次の行動を計画できる時間を確保する
- **動作**: 戦闘エリア入場を検知してもマクロを即座に開始せず、特定の入力を待機する
- **適用エリア**: 戦闘エリアのみ（町・隠れ家では適用しない）

#### 1.4.2 トリガー入力
以下のいずれかの入力を検知した時点でマクロを開始する：
- **左クリック**: キャラクター移動
- **右クリック**: メイン攻撃スキル使用
- **中央クリック**: サブ攻撃スキル使用
- **Qキー**: 移動用スキル

#### 1.4.3 動作フロー
1. ログ監視によりエリア入場を検知
2. 戦闘エリアかどうかを判定
3. Grace Period機能が有効な場合：
   - マクロを待機状態にする
   - ログに「Entering grace period - waiting for player input...」を出力
   - 入力監視を開始
4. トリガー入力を検知：
   - ログに「Player input detected (input_type) - starting macro」を出力
   - 入力監視を停止
   - マクロを開始
5. エリア退場時は待機状態をリセット

#### 1.4.4 設定項目
```yaml
grace_period:
  enabled: true           # Grace Period機能の有効/無効
  wait_for_input: true    # プレイヤー入力を待つかどうか
  trigger_inputs:         # マクロ開始のトリガーとなる入力
    - "mouse_left"        # 左クリック
    - "mouse_right"       # 右クリック
    - "mouse_middle"      # 中クリック
    - "q"                 # Qキー
```

#### 1.4.5 例外処理
- **手動操作の優先**: F12キーによる手動開始は待機状態を即座にキャンセル
- **緊急停止**: Ctrl+Shift+F12による緊急停止は待機中でも有効
- **タイムアウト**: 60秒経過後は自動的に待機状態を解除（オプション）

### 1.5. 統合制御システム（実装済み）
**MacroController**により、全モジュール（Flask/Skill/Tincture/LogMonitor）を統一的に制御する。

#### 機能概要
- **統一制御**: 単一のstart/stopメソッドで全機能制御
- **緊急停止**: F12キーによる即座停止
- **ステータス管理**: 全モジュールの動作状況集約
- **エラーハンドリング**: 個別モジュールエラーの安全な処理
- **GUI統合**: MainWindowとの完全連携
- **ヘッドレスモード**: GUI無しでの動作対応

#### 技術仕様
- スレッドセーフな実装
- 設定の動的反映
- 詳細ログシステム
- pynput依存関係の自動フォールバック

### 1.6. 将来の拡張機能
以下の機能は基本機能完了後の拡張として計画：

#### Divination Cardバフ検出機能
- 画面上部のバフエリアに表示されるDivination Cardバフアイコンの検出
- Wine of the Prophet使用により付与される40種類のバフを識別
- 優先度情報（highest-priority～lowest-priority）に基づく管理

#### フラスコチャージ・プログレスバー検出機能
- 各フラスコのチャージ量とプログレスバーの状態を画像認識で検出
- チャージが十分にある場合のみ使用する制御
- アセット例：`granite_flask_c060_p050.png`（チャージ60%、プログレス50%）

#### Divination Cardバフ連動機能
- 検出されたバフの優先度に基づくWine of the Prophet使用制御
- 高優先度バフ時の制御：highest-priority, high-priority等の重要度が高いバフが適用された場合、Wine of the Prophetの使用間隔を延長
- 低優先度バフ時の制御：low-priority, lowest-priority等の重要度が低いバフが適用された場合、Wine of the Prophetの使用頻度を短縮

**優先度別の使用間隔例（将来実装時の想定）**

| バフ優先度 | 使用間隔の調整 | 制御の狙い |
|------------|----------------|------------|
| highest-priority | 26～28秒 | 極めて有益なバフを最大限維持 |
| high-priority | 24～26秒 | 有益なバフを長く維持 |
| medium-priority | 20～22秒 | 標準的な間隔で使用 |
| low-priority | 12～15秒 | 低恩恵バフを早めに切り替え |
| lowest-priority | 8～10秒 | 最小恩恵バフを高頻度で切り替え |

### 1.7. GUI設定管理機能（実装済み）
#### 実装済み機能
- **タブ式インターフェース**: PyQt5による6タブ構成
- **リアルタイム設定変更**: GUI変更の即座反映
- **統計情報表示**: 各モジュールの使用統計
- **手動操作機能**: テスト・デバッグ用手動実行
- **設定永続化**: YAML設定ファイル自動保存
- **MacroController統合**: 実際のマクロ制御連携

#### タブ構成

**1. フラスコ設定タブ**

| 設定項目 | 内容 |
|----------|------|
| スロット番号 | 1～5のフラスコスロット |
| フラスコ名称 | ドロップダウンまたはテキスト入力（例：Granite Flask, Cinderswallow Urn, Wine of the Prophet等） |
| 割り当てキー | キーバインド設定（デフォルト：1, 2, 4, 5） |
| ループ間隔 | 最小値～最大値の範囲設定（例：7.210～7.300秒） |
| 有効/無効 | 各スロットの自動使用ON/OFF |

**2. Tincture設定タブ**

| 設定項目 | 内容 |
|----------|------|
| Tincture名称 | 使用するTinctureの選択（例：Sap of the Seasons） |
| 装備スロット | キーバインド設定（デフォルト：3） |
| 検出感度 | 画像認識の閾値調整 |
| 有効/無効 | Tincture自動使用のON/OFF |

**3. スキル設定タブ**

| 設定項目 | 内容 |
|----------|------|
| スキル名称 | スキル名の入力（例：Berserk, Molten Shell, Order! To Me!） |
| 割り当てキー | キーバインド設定（デフォルト：E, R, T） |
| 使用間隔 | 最小値～最大値の範囲設定（例：0.3～1.0秒） |
| 有効/無効 | 各スキルの自動使用ON/OFF |

**4. 全般設定タブ**

| 設定項目 | 内容 |
|----------|------|
| マクロ開始/停止キー | グローバルホットキーの設定（デフォルト：F12） |
| 緊急停止キー | 緊急停止用キーの設定（デフォルト：Ctrl+Shift+F12） |
| ログレベル | デバッグ情報の出力レベル |
| 画面解像度 | ゲーム画面の解像度確認・調整 |
| デバッグモード | 画像認識結果の可視化、マッチング精度の表示 |
| テストモード | 各機能の個別テスト実行 |

**5. 自動制御タブ**

| 設定項目 | 内容 |
|----------|------|
| ログ監視 | ログファイル監視機能のON/OFF |
| ログファイルパス | Client.txtの場所（デフォルトパスから変更可能） |
| 自動ON/OFF | エリア入退場での自動制御有効/無効 |
| Grace Period | 戦闘エリア入場時の待機機能ON/OFF |
| 待機入力設定 | Grace Periodを解除する入力の選択 |
| 除外エリア | 自動制御を適用しないエリアのリスト（例：町など） |
| ログパターン | エリア入退場を検出するための正規表現パターン |

**6. キャリブレーションタブ（実装済み）**

| 設定項目 | 内容 |
|----------|------|
| 検出エリア設定 | オーバーレイウィンドウ表示 |
| プリセット選択 | 解像度別初期座標（3種類） |
| 検出テスト | リアルタイムTincture検出確認 |
| エリア情報表示 | 現在の座標・サイズ（動的更新） |
| 詳細設定 | X,Y,幅,高さの手動調整 |
| 設定保存 | detection_areas.yaml保存 |

### 1.8. ログファイル監視機能（実装済み）
#### 実装済み仕様
- **監視対象**: Client.txtのリアルタイム監視
- **検出パターン**: "You have entered [エリア名]." 形式
- **エリア分類**: 安全エリア（町・隠れ家）と戦闘エリアの自動判定
- **Grace Period統合**: 戦闘エリア入場時の自動待機
- **再入場対応**: 1時間キャッシュによるスマート処理

#### 動作フロー（実装済み）:
1. **戦闘エリア入場**: Grace Period待機 → 入力検知 → マクロ開始
2. **安全エリア入場**: 即座にマクロ停止
3. **エリア退場**: マクロ自動停止
4. **再入場**: キャッシュによる効率的処理

#### ログパターン例（仮）
```
-- 入場パターン例
2025/01/15 12:34:56 Entering area "Crimson Temple"
2025/01/15 12:35:12 Entering area "Hideout"
2025/01/15 12:35:45 Entering area "Crimson Temple"

-- 退場パターン例
2025/01/15 12:40:23 Leaving area "Crimson Temple"
```

#### 実装詳細
- リアルタイムでログファイルの末尾を監視
- 新規ログエントリーを検出し、パターンマッチング実行
- エリア名の記録と状態管理（現在のエリア、前回のエリア）
- マクロのON/OFF制御はメインループと連携

## 2. 非機能要件

| 項目 | 要件 |
|------|------|
| 実行環境 | ・OS: Windows 10/11<br>・Python: 3.13.5対応<br>・ディスプレイ構成: マルチモニター対応（Primary/Center/Right）<br>・解像度対応: 1920x1080, 2560x1440, 3840x2160<br>・ゲーム設定: Windowed Fullscreen推奨 |
| パフォーマンス | ・CPU使用率: 5%以下（達成済み）<br>・画像認識処理: 100ms以内（達成済み）<br>・メモリ使用量: 200MB以下（最適化済み）<br>・Tincture検出: 100ms間隔での高速処理 |
| 信頼性 | 長時間のゲームプレイセッション（数時間）において、エラーなく安定して動作すること。 |
| 操作性 | ユーザーが単一の操作（特定のキーの組み合わせなど）でマクロ全体の開始と停止を切り替えられること。<br>Grace Period中でも手動操作を優先できること。 |
| アンチチート対策 | 全てのキー入力タイミングにミリ秒単位のランダムな揺らぎを持たせ、機械的なパターンを排除する。 |
| ユーザビリティ | 直感的なGUI操作。設定変更が即座に反映され、マクロの再起動が不要。<br>Grace Period待機中の状態表示。 |
| 設定の検証 | 不正な値（負の数値、空欄等）の入力を防ぐバリデーション機能。 |
| 拡張性 | 新しいフラスコ、スキル、バフの追加が容易な設計。画像ファイルと設定ファイルの追加/修正のみで対応可能。 |
| 保守性 | アセット（画像ファイル）の体系的な管理。READMEによる各ディレクトリの説明文書化。 |
| リアルタイム性 | ・ログファイル監視: 0.5秒間隔（設定可能）<br>・Grace Period入力検知: 100ms以内（pynput使用）<br>・Tincture検出: 100ms間隔での連続処理<br>・GUI更新: リアルタイム統計表示 |
| 耐障害性 | ・ログファイルアクセス失敗の独立処理<br>・pynput未インストール時の自動フォールバック<br>・個別モジュールエラーの分離処理<br>・スレッドセーフな実装による安定性<br>・設定ファイル破損時のデフォルト値復旧 |
| エラー処理 | ・画像認識失敗時の再試行機構<br>・ゲーム画面が見つからない場合の適切な通知<br>・設定ファイル破損時のデフォルト値での起動 |

## 3. 制約事項

1. **本マクロは、指定された解像度およびUIスケールでのみ正常な動作を保証する。** 解像度やUI設定が異なる場合、画像認識の精度が低下し、意図しない動作をする可能性がある。

2. **ゲームクライアントのアップデートにより、UI要素（フラスコやTinctureの表示位置、デザイン）が変更された場合、マクロの修正が必要となる。** 特に画像認識部分は影響を受けやすい。

3. **初期バージョンでは、フラスコは固定間隔での自動使用のみ対応。** チャージ量やプログレスバーの状態は考慮しない。

4. **Wine of the Prophetは初期実装では固定間隔（約20秒）での使用となり、Divination Cardバフの状態は考慮しない。**

5. **Divination Cardバフは同時に1つのみ適用されるゲーム仕様に基づいて将来の拡張を設計。**

6. **ログファイルの場所はSteam版のデフォルトパスを想定。** スタンドアロン版やEpic Games版では異なるパスになる可能性があり、手動での設定が必要。

7. **ログファイルのフォーマットはゲームのアップデートで変更される可能性があり、その場合はログパターンの更新が必要。**

8. **Grace Period機能はpynputライブラリに依存。** 環境によってはpynputが正常に動作しない場合があり、その際は機能が自動的に無効化される。（実装済みの自動フォールバック機能）

9. **本マクロの使用は、Path of Exileの利用規約に違反する可能性があります。使用によるアカウントへのいかなる不利益（アカウント停止等）についても、開発者は一切の責任を負いません。利用は完全に自己責任で行うものとします。**

10. **依存関係**: Python 3.13.5、PyQt5、OpenCV、pynput等の外部ライブラリが必要。requirements.txtで管理済み。

## 4. 開発状況

### 完了済み機能（2025-07-05現在）：

**✅ 基本機能（完全実装済み）**
- フラスコ自動使用（4スロット、独立スレッド処理）
- スキル自動発動（Berserk/Molten Shell/Order! To Me!）
- Tincture自動使用（Active/Idle状態検出）
- 統合制御システム（MacroController）
- GUI設定画面（6タブ構成、リアルタイム更新）

**✅ 高度機能（完全実装済み）**
- オーバーレイ検出エリア設定（PyQt5、pynput統合）
- ログファイル監視（エリア入退場自動検出）
- Grace Period機能（戦闘エリア入場時待機）
- 画像認識システム（OpenCV、感度調整）
- 設定管理（YAML、動的更新）

**✅ 品質保証（完全実装済み）**
- 包括的テストスイート（4種類）
- エラーハンドリング（フォールバック処理）
- スレッドセーフ実装
- パフォーマンス最適化
- 構文検証（全ファイル合格）

**📋 将来の拡張機能**
- Divination Cardバフ検出
- フラスコチャージ・プログレスバー検出
- 機械学習による動的制御