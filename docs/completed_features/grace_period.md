# Grace Period（無敵時間）機能

## 概要
戦闘エリア入場時にプレイヤー入力を待つGrace Period（無敵時間）機能。プレイヤーが準備を整えるまでマクロの自動開始を待機し、明示的な入力でマクロを開始します。

## 主要機能

### 自動トグル機能（Phase 7）
- **60秒固定タイムアウト**: 戦闘エリア入場から60秒で自動的にマクロON
- **特定入力検知**: 左/右/中クリック、Qキーのみでマクロ即座開始
- **エリアキャッシュ制御**: 設定により毎回Grace Period発動可能
- **安全エリア判定**: 町・隠れ家では従来通りGrace Period適用外

### 入力監視システム
- **pynputライブラリ**: マウス・キーボード監視
- **条件付きインポート**: 依存関係未インストール時の自動フォールバック
- **入力フィルタリング**: 指定された入力のみ処理、その他は無視
- **詳細ログ**: 全動作段階の追跡可能

### エリア判定
- **戦闘エリア**: Grace Period適用
- **安全エリア**: 町・隠れ家では即座にマクロ無効化
- **スマート再入場**: 1時間以内の同エリアは設定により待機スキップ

## 動作フロー

### 戦闘エリア入場時
1. **ログ検知**: `"You have entered [エリア名]."` 検出
2. **エリア判定**: 安全エリア（町・隠れ家）以外かチェック
3. **Grace Period開始**: 入力監視開始、60秒タイマー開始
4. **入力監視**: pynputでマウス・キーボード監視
5. **入力検知**: 指定入力検知 → マクロ開始
6. **タイムアウト**: 60秒経過 → 自動的にマクロ開始

### 設定オプション
```yaml
grace_period:
  enabled: true
  duration: 60  # 60秒固定
  trigger_inputs:
    mouse_buttons: ["left", "right", "middle"]
    keyboard_keys: ["q"]
  clear_cache_on_reenter: true  # 毎回Grace Period発動
```

## 技術仕様

### LogMonitorクラス拡張
- **pynput統合**: 条件付きインポートでエラー耐性
- **Grace Period状態管理**: 開始・停止・入力検知
- **タイマー機能**: threading.Timerによる60秒管理
- **入力フィルタリング**: 設定されたボタン・キーのみ処理

### MacroController統合
- **統合制御**: LogMonitorの開始・停止管理
- **設定共有**: full_config引数での設定伝播
- **エラーハンドリング**: pynput未インストール時の安全な処理

### 新メソッド実装
- **_start_grace_period()**: 待機開始制御
- **_stop_grace_period()**: 待機停止制御
- **_start_input_monitoring()**: 入力監視開始
- **_stop_input_monitoring()**: 入力監視停止
- **_on_grace_period_timeout()**: 60秒タイムアウト処理

## プレイヤー体験

### 安全な入場
- 戦闘エリア入場時に自動でマクロ待機
- プレイヤーが準備を整えるまで安全
- 明示的な入力でマクロ開始

### 効率的な処理
- 同エリア再入場時の待機スキップオプション
- 1時間キャッシュによる重複待機回避
- 自動タイムアウトによる確実な開始

## フォールバック機能
- **pynput未インストール**: 自動的にGrace Period無効化
- **エラー時**: 安全にマクロ即座開始
- **設定エラー**: デフォルト動作での継続

## 実装ファイル
- **src/modules/log_monitor.py**: メイン実装
- **src/core/macro_controller.py**: 統合制御
- **config/default_config.yaml**: 設定管理
- **config/user_config.yaml**: ユーザー設定

## テスト
- **test_grace_period_auto_toggle.py**: 統合テスト
- **test_grace_period_simple.py**: コアロジックテスト

## 実行結果
- **テスト合格率**: 5/5 完全合格
- **要件適合性**: 100%達成
- **品質保証**: 構文チェック全合格